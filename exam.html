<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ujian Berlangsung - PERGUNU Situbondo</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/animate.css">
</head>
<body class="exam-bg">
    <div class="exam-header">
        <div class="exam-timer" id="exam-timer">120:00</div>
        <div class="exam-info">
            <span id="exam-subject">Ujian Matematika</span>
            <span id="exam-grade">Kelas XII</span>
        </div>
    </div>
    
    <div class="exam-container">
        <div class="question-container">
            <div class="question-number">Soal <span id="current-q">1</span> dari <span id="total-q">50</span></div>
            <div class="question-text" id="question-text">
                Berapakah hasil dari 2 + 2 × 2?
            </div>
            
            <div class="options-container">
                <div class="option" data-option="A">
                    <span class="option-letter">A</span>
                    <span class="option-text">6</span>
                </div>
                <div class="option" data-option="B">
                    <span class="option-letter">B</span>
                    <span class="option-text">8</span>
                </div>
                <div class="option" data-option="C">
                    <span class="option-letter">C</span>
                    <span class="option-text">4</span>
                </div>
                <div class="option" data-option="D">
                    <span class="option-letter">D</span>
                    <span class="option-text">2</span>
                </div>
            </div>
            
            <div class="answer-explanation" id="answer-explanation" style="display: none;">
                <h3>Penjelasan Jawaban:</h3>
                <p>Menurut aturan operasi matematika, perkalian harus dikerjakan terlebih dahulu sebelum penjumlahan. Jadi 2 + 2 × 2 = 2 + (2 × 2) = 2 + 4 = 6.</p>
            </div>
        </div>
        
        <div class="exam-controls">
            <button id="prev-btn" class="btn-secondary">Soal Sebelumnya</button>
            <button id="next-btn" class="btn-primary">Soal Berikutnya</button>
            <button id="skip-btn" class="btn-secondary">Lewati Soal</button>
            <button id="finish-btn" class="btn-warning">Selesaikan Ujian</button>
        </div>
        
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 2%;"></div>
            </div>
            <div class="progress-stats">
                <span class="stat-correct">Benar: <span id="stat-correct">0</span></span>
                <span class="stat-wrong">Salah: <span id="stat-wrong">0</span></span>
                <span class="stat-skipped">Terlewat: <span id="stat-skipped">0</span></span>
            </div>
        </div>
    </div>
    
    <!-- Music Player -->
    <div class="music-player">
        <button id="music-toggle" class="music-btn">
            <i class="icon-music"></i>
        </button>
        <input type="range" id="music-volume" min="0" max="1" step="0.1" value="0.5">
        <audio id="background-music" loop>
            <source src="assets/audio/background-music.mp3" type="audio/mpeg">
        </audio>
    </div>
    
    <!-- Warning notification -->
    <div class="warning-notification" id="warning-notification" style="display: none;">
        Perhatian! Ujian akan berakhir dalam waktu <span id="warning-time">10</span> menit. Mohon pastikan semua jawaban telah diselesaikan dan diperiksa sebelum waktu habis. Terima kasih atas partisipasi Anda.
    </div>

    <script src="assets/js/main.js"></script>
    <script src="assets/js/questions.js"></script>
    <script>
        // Exam variables
        let currentQuestion = 0;
        let answers = [];
        let correctAnswers = 0;
        let wrongAnswers = 0;
        let skippedQuestions = 0;
        let timerInterval;
        let timeLeft = 120 * 60; // 120 minutes in seconds
        
        // DOM elements
        const questionText = document.getElementById('question-text');
        const currentQ = document.getElementById('current-q');
        const totalQ = document.getElementById('total-q');
        const options = document.querySelectorAll('.option');
        const answerExplanation = document.getElementById('answer-explanation');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const skipBtn = document.getElementById('skip-btn');
        const finishBtn = document.getElementById('finish-btn');
        const progressFill = document.getElementById('progress-fill');
        const statCorrect = document.getElementById('stat-correct');
        const statWrong = document.getElementById('stat-wrong');
        const statSkipped = document.getElementById('stat-skipped');
        const examTimer = document.getElementById('exam-timer');
        const warningNotification = document.getElementById('warning-notification');
        
        // Get exam data
        const examData = JSON.parse(localStorage.getItem('examData'));
        const participant = JSON.parse(localStorage.getItem('participantData'));
        
        // Set exam info
        document.getElementById('exam-subject').textContent = examData.subject.toUpperCase();
        if (participant.status === 'pelajar') {
            document.getElementById('exam-grade').textContent = 'Kelas ' + examData.grade;
        }
        
        // Load questions based on exam type
        let questions = [];
        if (participant.status === 'pelajar') {
            questions = studentQuestions[examData.subject];
        } else {
            questions = generalQuestions[examData.subject];
        }
        totalQ.textContent = questions.length;
        
        // Initialize answers array
        questions.forEach((q, index) => {
            answers[index] = {
                selected: null,
                correct: q.correctAnswer,
                isCorrect: false,
                skipped: false
            };
        });
        
        // Display question
        function displayQuestion(index) {
            const q = questions[index];
            questionText.textContent = q.question;
            
            options.forEach((opt, i) => {
                opt.querySelector('.option-text').textContent = q.options[i];
                
                // Reset option styles
                opt.classList.remove('correct', 'wrong', 'selected');
                
                // Show correct answer if already answered
                if (answers[index].selected !== null) {
                    if (opt.dataset.option === q.correctAnswer) {
                        opt.classList.add('correct');
                    } else if (opt.dataset.option === answers[index].selected && !answers[index].isCorrect) {
                        opt.classList.add('wrong');
                    }
                    
                    if (opt.dataset.option === answers[index].selected) {
                        opt.classList.add('selected');
                    }
                }
            });
            
            // Show explanation if answered
            if (answers[index].selected !== null) {
                answerExplanation.style.display = 'block';
                answerExplanation.querySelector('p').textContent = q.explanation;
            } else {
                answerExplanation.style.display = 'none';
            }
            
            // Update question number
            currentQ.textContent = index + 1;
            
            // Update button states
            prevBtn.disabled = index === 0;
            nextBtn.disabled = index === questions.length - 1;
            
            // Update progress
            updateProgress();
        }
        
        // Option selection
        options.forEach(opt => {
            opt.addEventListener('click', function() {
                // Don't allow changing answer if already answered
                if (answers[currentQuestion].selected !== null) return;
                
                const selectedOption = this.dataset.option;
                answers[currentQuestion].selected = selectedOption;
                answers[currentQuestion].isCorrect = selectedOption === questions[currentQuestion].correctAnswer;
                answers[currentQuestion].skipped = false;
                
                // Play sound based on answer
                const audio = new Audio(answers[currentQuestion].isCorrect 
                    ? 'assets/audio/jawabanbenar.mp3' 
                    : 'assets/audio/jawabansalah.mp3');
                audio.play();
                
                // Update stats
                if (answers[currentQuestion].isCorrect) {
                    correctAnswers++;
                    statCorrect.textContent = correctAnswers;
                } else {
                    wrongAnswers++;
                    statWrong.textContent = wrongAnswers;
                }
                
                // Show answer feedback
                this.classList.add('selected');
                if (answers[currentQuestion].isCorrect) {
                    this.classList.add('correct');
                } else {
                    this.classList.add('wrong');
                    
                    // Also show correct answer
                    options.forEach(o => {
                        if (o.dataset.option === questions[currentQuestion].correctAnswer) {
                            o.classList.add('correct');
                        }
                    });
                }
                
                // Show explanation
                answerExplanation.style.display = 'block';
                answerExplanation.querySelector('p').textContent = questions[currentQuestion].explanation;
            });
        });
        
        // Navigation buttons
        prevBtn.addEventListener('click', function() {
            if (currentQuestion > 0) {
                currentQuestion--;
                displayQuestion(currentQuestion);
            }
        });
        
        nextBtn.addEventListener('click', function() {
            if (currentQuestion < questions.length - 1) {
                currentQuestion++;
                displayQuestion(currentQuestion);
            }
        });
        
        skipBtn.addEventListener('click', function() {
            if (answers[currentQuestion].selected === null) {
                answers[currentQuestion].skipped = true;
                skippedQuestions++;
                statSkipped.textContent = skippedQuestions;
            }
            
            if (currentQuestion < questions.length - 1) {
                currentQuestion++;
                displayQuestion(currentQuestion);
            }
        });
        
        finishBtn.addEventListener('click', function() {
            if (confirm('Apakah Anda yakin ingin menyelesaikan ujian sekarang? Soal yang belum dijawab akan dianggap salah.')) {
                finishExam();
            }
        });
        
        // Update progress bar
        function updateProgress() {
            const answered = answers.filter(a => a.selected !== null).length;
            const progress = (answered / questions.length) * 100;
            progressFill.style.width = `${progress}%`;
        }
        
        // Timer function
        function startTimer() {
            timerInterval = setInterval(function() {
                timeLeft--;
                
                // Update timer display
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                examTimer.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                
                // Warning when 10 minutes left
                if (timeLeft === 10 * 60) {
                    warningNotification.style.display = 'block';
                    warningNotification.querySelector('#warning-time').textContent = '10';
                    
                    // Make timer bigger
                    examTimer.classList.add('warning');
                }
                
                // Hide warning when 1 minute left
                if (timeLeft === 60) {
                    warningNotification.style.display = 'none';
                }
                
                // End exam when time's up
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    finishExam();
                }
            }, 1000);
        }
        
        // Finish exam
        function finishExam() {
            clearInterval(timerInterval);
            
            // Calculate final score
            const totalAnswered = correctAnswers + wrongAnswers;
            const unanswered = questions.length - totalAnswered;
            const score = Math.round((correctAnswers / questions.length) * 100);
            
            // Save results
            const results = {
                participant: participant,
                exam: examData,
                answers: answers,
                correct: correctAnswers,
                wrong: wrongAnswers,
                skipped: skippedQuestions,
                unanswered: unanswered,
                score: score,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('examResults', JSON.stringify(results));
            
            // Redirect to results page
            window.location.href = 'results.html';
        }
        
        // Music player
        const musicToggle = document.getElementById('music-toggle');
        const musicVolume = document.getElementById('music-volume');
        const backgroundMusic = document.getElementById('background-music');
        
        musicToggle.addEventListener('click', function() {
            if (backgroundMusic.paused) {
                backgroundMusic.play();
                this.innerHTML = '<i class="icon-music-on"></i>';
            } else {
                backgroundMusic.pause();
                this.innerHTML = '<i class="icon-music"></i>';
            }
        });
        
        musicVolume.addEventListener('input', function() {
            backgroundMusic.volume = this.value;
        });
        
        // Initialize exam
        displayQuestion(0);
        startTimer();
    </script>
</body>
</html>
